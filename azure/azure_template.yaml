parameters:
  - name: REPO_NAME
    type: string
  - name: IGNORE_STYLE
    type: boolean
    default: false
  - name: ISORT
    type: boolean
    default: false
  - name: PYLINT
    type: boolean
    default: false
  - name: COMPLEX
    type: boolean
    default: false
  - name: GCC_CONFIG
    type: string
    default: None
  - name: INTEL_CONFIG
    type: string
    default: None
  - name: BUILD_REAL
    type: string
    default: .github/build_real.sh
  - name: TEST_REAL
    type: string
    default: .github/test_real.sh
  - name: BUILD_COMPLEX
    type: string
    default: .github/build_complex.sh
  - name: TEST_COMPLEX
    type: string
    default: .github/test_complex.sh
  - name: IMAGE
    type: string
    default: public
  - name: SKIP_TESTS
    type: boolean
    default: false
  - name: TIMEOUT
    type: number
    default: 0
  - name: COVERAGE
    type: boolean
    default: false
  - name: TAPENADE
    type: boolean
    default: false
  - name: TAPENADE_SCRIPT
    type: string
    default: .github/build_tapenade.sh
  - name: TAPENADE_VERSION
    type: string
    default: 3.10
  - name: CLANG_FORMAT
    type: boolean
    default: false

stages:
  - stage: Test_Real
    dependsOn: []
    displayName: Real Test
    condition: not(${{ parameters.SKIP_TESTS }})
    jobs:
      - template: azure_build.yaml
        parameters:
          REPO_NAME: ${{ parameters.REPO_NAME }}
          GCC_CONFIG: ${{ parameters.GCC_CONFIG }}
          INTEL_CONFIG: ${{ parameters.INTEL_CONFIG }}
          BUILD: ${{ parameters.BUILD_REAL }}
          TEST: ${{ parameters.TEST_REAL }}
          IMAGE: ${{ parameters.IMAGE }}
          TIMEOUT: ${{ parameters.TIMEOUT }}
          COVERAGE: ${{ parameters.COVERAGE }}

  - stage: Test_Complex
    dependsOn: []
    displayName: Complex Test
    condition: and(eq(${{ parameters.COMPLEX }}, true), not(${{ parameters.SKIP_TESTS }}))
    jobs:
      - template: azure_build.yaml
        parameters:
          REPO_NAME: ${{ parameters.REPO_NAME }}
          GCC_CONFIG: ${{ parameters.GCC_CONFIG }}
          INTEL_CONFIG: ${{ parameters.INTEL_CONFIG }}
          BUILD: ${{ parameters.BUILD_COMPLEX }}
          TEST: ${{ parameters.TEST_COMPLEX }}
          IMAGE: ${{ parameters.IMAGE }}
          TIMEOUT: ${{ parameters.TIMEOUT }}
          COVERAGE: ${{ parameters.COVERAGE }}

  - stage: Style
    dependsOn: []
    displayName: Style Checks
    condition: not(${{ parameters.SKIP_TESTS }})
    jobs:
      - template: azure_style.yaml
        parameters:
          REPO_NAME: ${{ parameters.REPO_NAME }}
          IGNORE_STYLE: ${{ parameters.IGNORE_STYLE }}
          ISORT: ${{ parameters.ISORT }}
          PYLINT: ${{ parameters.PYLINT }}
          CLANG_FORMAT: ${{ parameters.CLANG_FORMAT }}

  - stage: Tapenade
    dependsOn: []
    displayName: Tapenade Checks
    condition: ${{ parameters.TAPENADE }}
    jobs:
      - template: azure_tapenade.yaml
        parameters:
          REPO_NAME: ${{ parameters.REPO_NAME }}
          TAPENADE: ${{ parameters.TAPENADE }}
          TAPENADE_SCRIPT: ${{ parameters.TAPENADE_SCRIPT }}
          TAPENADE_VERSION: ${{ parameters.TAPENADE_VERSION }}
